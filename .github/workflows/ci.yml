name: Network Services Delivery with NetDevOps demo

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  check-out:
    runs-on: self-hosted
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3

  inventory-lint:
    runs-on: self-hosted
    needs: check-out
    steps:
    - name: ğŸ—³ï¸ Lint inventory
      run: |
        make lint

  build-staging-env:
    runs-on: self-hosted
    needs: inventory-lint
    steps:
    - name: ğŸ› ï¸ Build staging env
      run: |
        make render
        make build
        make run
        make compile
        make reload

  test:
    runs-on: self-hosted
    needs: build-staging-env
    steps:
    - name: ğŸ¤– Run tests
      env:
        ENVIRONMENT: test
        TEST_AUTH_HASH: ${{ secrets.TEST_AUTH_HASH }}
      run: |
        make netsims
        make test

  create-artifact-test:
    runs-on: self-hosted
    needs: test
    if: always()
    steps:
    - name: ğŸ“¦ Generate artifacts
      env:
        ENVIRONMENT: test
      run: |
        make artifacts

    - name: ğŸ“¦ Upload packages artifact
      uses: actions/upload-artifact@v4
      with:
        name: netdevops_packages
        path: preconfigs/demo_packages.tar.gz

    - name: ğŸ“¦ Upload tests artifact
      uses: actions/upload-artifact@v4
      with:
        name: netdevops_tests
        path: preconfigs/demo_test.tar.gz

    - name: ğŸ“¦ Upload logs artifact
      uses: actions/upload-artifact@v4
      with:
        name: netdevops_logs
        path: preconfigs/demo_logs.tar.gz

  # commit:
  #   runs-on: self-hosted
  #   needs: create-artifact-test
  #   if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
  #   steps:
  #   - name: âš¡ï¸ Commit inventory changes
  #     env:
  #       ENVIRONMENT: production
  #       PROD_AUTH_HASH: ${{ secrets.PROD_AUTH_HASH }}
  #     run: |
  #       make test

  # create-artifact-commit:
  #   runs-on: self-hosted
  #   needs: commit
  #   steps:
  #   - name: ğŸ“¦ Generate artifacts
  #     env:
  #       ENVIRONMENT: production
  #     run: |
  #       make artifacts

  #   - name: ğŸ“¦ Upload tests artifact
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: netdevops_commit
  #       path: preconfigs/netdevops_commit.tar.gz

  # release:
  #   runs-on: self-hosted
  #   needs: create-artifact-commit
  #   if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
  #   steps:
  #     - name: â­ï¸ Get the latest tag
  #       id: get_latest_tag
  #       run: make get-current-release-tag
        
  #     - name: â­ï¸ Increment version
  #       id: increment_version
  #       run: make calculate-new-release-tag VERSION=${{ env.tag }}

  #     - name: â­ï¸ Create Release and Upload Assets
  #       uses: softprops/action-gh-release@v1
  #       with:
  #         name: â­ï¸ Release v.${{ env.new_version }} â­ï¸
  #         tag_name: ${{ env.new_version }}
  #         body: |
  #           ğŸ… Automated Inventory Release v.${{ env.new_version }} ğŸ…
  #         files: preconfigs/netdevops_commit.tar.gz
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-staging-env:
    runs-on: self-hosted
    needs: create-artifact-test
    steps:
    - name: ğŸ§¹ Cleanup resources
      run: make down